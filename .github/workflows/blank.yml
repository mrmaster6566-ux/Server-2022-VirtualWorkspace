name: Windows Server 2022 Workspace

on:
  workflow_dispatch:

jobs:
  setup-workspace:
    runs-on: windows-2022
    timeout-minutes: 360

    steps:
      - name: ğŸ§‘ Create User and Configure Groups
        run: |
          Write-Host "ğŸ”§ Initializing Windows Server 2022 Workspace..."
          Write-Host "ğŸ‘¤ Creating local user 'User'..."
          net user User act1-1234 /add
          Write-Host "âœ… User 'User' created."

          Write-Host "ğŸ” Adding 'User' to Administrators group..."
          net localgroup Administrators User /add
          Write-Host "âœ… User added to Administrators."

          Write-Host "ğŸ” Adding 'User' to Remote Desktop Users group..."
          net localgroup 'Remote Desktop Users' User /add
          Write-Host "âœ… User added to Remote Desktop Users."

      - name: ğŸµ Configure Audio Service
        run: |
          Write-Host "ğŸ”Š Configuring Windows Audio service to start automatically..."
          sc config Audiosrv start= auto
          net start Audiosrv
          Write-Host "âœ… Audio service configured and started."

      - name: ğŸŒ Install and Configure Tailscale
        run: |
          Write-Host "ğŸ”§ Downloading Tailscale installer..."
          powershell -Command "Invoke-WebRequest -Uri 'https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe' -OutFile '$env:USERPROFILE\\tailscale-setup.exe'"

          Write-Host "ğŸ’» Installing Tailscale silently..."
          & "$env:USERPROFILE\tailscale-setup.exe" /quiet

          Write-Host "ğŸ” Detecting installed Tailscale path..."
          if (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe") {
              $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
          } elseif (Test-Path "$env:ProgramFiles(x86)\Tailscale\tailscale.exe") {
              $tailscalePath = "$env:ProgramFiles(x86)\Tailscale\tailscale.exe"
          } else {
              Write-Host "âŒ Tailscale executable not found!"
              exit 1
          }

          Write-Host "ğŸ”— Starting Tailscale for secure remote access..."
          & $tailscalePath up --hostname=windows2022-workspace
          Write-Host "âœ… Tailscale is running."

      - name: ğŸ’¬ Display Workspace Info
        run: |
          Write-Host "==============================================="
          Write-Host "ğŸ¢ Windows Server 2022 Workspace Ready"
          Write-Host "-----------------------------------------------"
          Write-Host "ğŸ’» Login Information:"
          Write-Host "    Username: User"
          Write-Host "    Password: act1-1234"
          Write-Host "    RDP access enabled"
          Write-Host ""
          Write-Host "ğŸŒ Tailscale hostname: windows2022-workspace"
          Write-Host "-----------------------------------------------"
          Write-Host "ğŸŒŸğŸ»ğŸ§¸ MADE BY DANIEL 64"
          Write-Host "==============================================="

      - name: â³ Workspace End Time and 6-Hour Active Session
        run: |
          Write-Host "ğŸ• Workspace will remain active until (Minsk time):"
          powershell -Command "$tz = [System.TimeZoneInfo]::FindSystemTimeZoneById('FLE Standard Time'); $endTime = [System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId((Get-Date).AddHours(6), $tz.Id); Write-Host '    ' $endTime"
          Write-Host ""
          Write-Host "ğŸ•’ Keeping Windows Server 2022 workspace active for 6 hours..."
          for ($i=1; $i -le 360; $i++) {
              Write-Host "â³ Runtime: $i / 360 minutes elapsed"
              Start-Sleep -Seconds 60
          }
          Write-Host "ğŸ’¤ Workspace session complete â€” shutting down."
