name: Windows Server 2022 Workspace (CMD + PowerShell Loop)

on:
  workflow_dispatch:

jobs:
  setup-workspace:
    runs-on: windows-2022
    timeout-minutes: 360

    steps:
      - name: ğŸ§‘ Create User and Configure Groups
        shell: cmd
        run: |
          echo ğŸ”§ Initializing Windows Server 2022 Workspace...
          echo ğŸ‘¤ Creating local user 'User'...
          net user User act1-1234 /add
          echo âœ… User 'User' created.

          echo ğŸ” Adding 'User' to Administrators group...
          net localgroup Administrators User /add
          echo âœ… User added to Administrators.

          echo ğŸ” Adding 'User' to Remote Desktop Users group...
          net localgroup "Remote Desktop Users" User /add
          echo âœ… User added to Remote Desktop Users.

      - name: ğŸµ Configure Audio Service
        shell: cmd
        run: |
          echo ğŸ”Š Configuring Windows Audio service to start automatically...
          sc config Audiosrv start= auto
          net start Audiosrv
          echo âœ… Audio service configured and started.

      - name: ğŸŒ Install and Configure Tailscale
        shell: cmd
        run: |
          echo ğŸ”§ Downloading Tailscale installer...
          powershell -Command "Invoke-WebRequest -Uri 'https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe' -OutFile '%USERPROFILE%\tailscale-setup.exe'"

          echo ğŸ’» Installing Tailscale silently...
          "%USERPROFILE%\tailscale-setup.exe" /quiet

          echo â³ Waiting 20 seconds for Tailscale services to initialize...
          powershell -Command "Start-Sleep -Seconds 20"

          echo ğŸ” Detecting installed Tailscale path...
          if exist "%ProgramFiles%\Tailscale\tailscale.exe" (
              set "TAILSCALE_PATH=%ProgramFiles%\Tailscale\tailscale.exe"
          ) else if exist "%ProgramFiles(x86)%\Tailscale\tailscale.exe" (
              set "TAILSCALE_PATH=%ProgramFiles(x86)%\Tailscale\tailscale.exe"
          ) else (
              echo âŒ Tailscale executable not found!
              exit /b 1
          )

          echo ğŸ”— Starting Tailscale for secure remote access...
          "%TAILSCALE_PATH%" up --hostname=windows2022-workspace
          echo âœ… Tailscale is running.

      - name: ğŸ’¬ Display Workspace Info
        shell: cmd
        run: |
          echo ===============================================
          echo ğŸ¢ Windows Server 2022 Workspace Ready
          echo -----------------------------------------------
          echo ğŸ’» Login Information:
          echo     Username: User
          echo     Password: act1-1234
          echo     RDP access enabled
          echo.
          echo ğŸŒ Tailscale hostname: windows2022-workspace
          echo -----------------------------------------------
          echo ğŸŒŸğŸ»ğŸ§¸ MADE BY DANIEL 64. DM IN TELEGRAM @daniel64idk IF SOMETHING IS WRONG OR NOT WORKING 
          echo ===============================================

      - name: â³ Display Minsk Time and Keep-Alive Loop
        shell: powershell
        run: |
          # Show Minsk timezone end time
          $tz = [System.TimeZoneInfo]::FindSystemTimeZoneById('FLE Standard Time')
          $endTime = [System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId((Get-Date).AddHours(6), $tz.Id)
          Write-Host "ğŸ• Workspace will remain active until (Minsk time): $endTime"

          # Print Enjoy! once
          Write-Host "Enjoy!"

          # Infinite silent loop to keep workspace alive
          while ($true) {
              Start-Sleep -Seconds 10
          }
